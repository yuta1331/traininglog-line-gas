# エラーシナリオ図解

## 📊 302エラーの発生メカニズム

### シナリオ1: executeAs設定によるPOSTリダイレクト

```
┌─────────────────────────────────────────────────────────────────┐
│                    LINE Messaging API                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ POST /webhook
                            │ イベントデータ
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Google Apps Script Web App                         │
│                                                                  │
│  appsscript.json:                                               │
│  {                                                              │
│    "webapp": {                                                  │
│      "executeAs": "USER_DEPLOYING",  ← デプロイ者として実行     │
│      "access": "ANYONE_ANONYMOUS"    ← 匿名アクセス許可        │
│    }                                                            │
│  }                                                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ GAS内部処理
                            ▼
                    ┌───────────────┐
                    │ POST処理      │
                    │ リダイレクト  │
                    └───────┬───────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │ 302 Found       │
                    │ （内部リダイレクト）│
                    └────────┬────────┘
                            │
                            ▼
                   ┌────────────────┐
                   │ LINE側でエラー │
                   │ 「302」記録    │
                   └────────────────┘
```

**注**: 必ずしもOAuth認証画面へのリダイレクトではなく、**Apps Script Web App自体のPOST処理特有のリダイレクト挙動**です。

### シナリオ2: 正しい設定（executeAs: USER_ACCESSING）

```
┌─────────────────────────────────────────────────────────────────┐
│                    LINE Messaging API                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ POST /webhook
                            │ イベントデータ
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Google Apps Script Web App                         │
│                                                                  │
│  appsscript.json:                                               │
│  {                                                              │
│    "webapp": {                                                  │
│      "executeAs": "USER_ACCESSING",  ← 実行ユーザー = アクセス者│
│      "access": "ANYONE_ANONYMOUS"     ← 匿名アクセス許可       │
│    }                                                            │
│  }                                                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ 匿名ユーザーとして実行
                            ▼
                    ┌───────────────┐
                    │ 権限確認      │
                    │ → OK (常に)   │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ doPost 実行   │
                    │ 200 OK 返却   │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ LINE側で成功  │
                    └───────────────┘
```

---

## ⏱️ request_timeout エラーの発生メカニズム

### タイムライン: 通常メッセージ（タイムアウトケース）

```
時刻    処理                                    累積時間
────────────────────────────────────────────────────────
0.0s   │ Webhook受信
       ├─ doPost開始
0.0s   ├─ JSONパース                              0.05s
0.05s  ├─ スプレッドシート取得(Log)                0.60s
0.65s  ├─ ユーザー認証(スプレッドシート読込)      1.65s
1.65s  ├─ メッセージパース                        1.75s
1.75s  ├─ appendRow × 3回                         3.75s
       │
2.0s   │ ⏰ LINE Webhook タイムアウト！（2秒経過）
       │ └─ request_timeout エラー記録
       │
3.75s  ├─ LINE返信API呼び出し                     5.00s
5.00s  └─ 200 OK レスポンス返却（遅すぎる）
       ▼
       ❌ 5秒で完了だが、2秒以内にレスポンス返却できず → タイムアウト
```

**重要**: 処理は5秒で完了しているが、**2秒以内にレスポンスを返せない**ためタイムアウトします。

### タイムライン: JSON書き出し（タイムアウトケース）

```
時刻    処理                                    累積時間
────────────────────────────────────────────────────────
0.0s   │ Webhook受信
       ├─ doPost開始
0.0s   ├─ JSONパース                              0.05s
0.05s  ├─ スプレッドシート取得(Log)                0.60s
0.60s  ├─ ユーザー認証(スプレッドシート読込)      1.60s
1.60s  ├─ "json書き出し" 判定
       ├─ loadTrainingRecords()
       │
2.0s   │ ⏰ LINE Webhook タイムアウト！（2秒経過）
       │ └─ request_timeout エラー記録
       │
       │  └─ getDataRange().getValues()          5.10s
5.10s  ├─ convertRecordsToJson()                  6.60s
6.60s  ├─ saveJsonToDrive()
       │  ├─ 既存ファイル検索                     7.10s
       │  ├─ ファイル削除                         7.60s
       │  ├─ 新規ファイル作成                     8.10s
       │  └─ 権限設定                             9.10s
9.10s  ├─ LINE返信API呼び出し                    10.60s
10.60s └─ 200 OK レスポンス返却（遅すぎる）
       ▼
       ❌ 10.6秒 → タイムアウト（2秒時点ですでにタイムアウト）
```

**重要**: 早期レスポンス返却を実装すれば、処理が10秒かかってもタイムアウトしません。

---

## 🔄 処理フローの比較

### 現在の実装（同期処理）

```
┌───────────┐
│ Webhook   │
│ 受信      │
└─────┬─────┘
      │
      ▼
┌─────────────────────────────────────────┐
│           doPost関数                    │
│                                         │
│  1. バリデーション                      │
│     ↓                                   │
│  2. DB読み込み (ユーザー認証)           │
│     ↓                                   │
│  3. メッセージ処理                      │
│     ↓                                   │
│  4. DB書き込み                          │
│     ↓                                   │
│  5. LINE返信API呼び出し                 │
│     ↓                                   │
│  6. ← ここで初めてレスポンス返却        │
│                                         │
└─────┬───────────────────────────────────┘
      │
      ▼
┌─────────────┐
│ 200 OK      │
│ または      │
│ タイムアウト│
└─────────────┘

⏱️ 全処理完了まで: 2-14秒
⚠️ **2秒を超えるとタイムアウト**
```

### 推奨実装（早期レスポンス）

```
┌───────────┐
│ Webhook   │
│ 受信      │
└─────┬─────┘
      │
      ▼
┌─────────────────────────────────────────┐
│           doPost関数                    │
│                                         │
│  1. バリデーション（イベント形式確認）  │
│     ↓                                   │
│  2. 即座にレスポンス返却 ───────────────┼──┐
│                                         │  │
└─────────────────────────────────────────┘  │
                                             │
      ┌──────────────────────────────────────┘
      │
      ▼
┌─────────────┐
│ 200 OK      │ ← 0.1秒以内に返却
└─────────────┘

      │ (並行して処理継続)
      ▼
┌─────────────────────────────────────────┐
│     非同期処理 (トリガーまたは継続)     │
│                                         │
│  3. DB読み込み (ユーザー認証)           │
│  4. メッセージ処理                      │
│  5. DB書き込み                          │
│  6. LINE返信API呼び出し                 │
│                                         │
└─────────────────────────────────────────┘

⏱️ レスポンス返却: 0.1秒（2秒以内）
⏱️ 全処理完了: 2-14秒（Webhookタイムアウトには無関係）
✅ タイムアウトなし

**重要**: 処理が10秒以上かかっても、2秒以内にレスポンスを返せばタイムアウトしません。
```

---

## 📈 データ量と処理時間の関係

### スプレッドシート読み込み時間

```
行数        getDataRange()実行時間
────────────────────────────────
100行       200-500ms    ✅
500行       500-1500ms   ⚠️
1000行      1000-3000ms  ⚠️⚠️
5000行      3000-8000ms  🔴
10000行     5000-15000ms 🔴🔴
```

### appendRow vs setValues

```
セット数    appendRow        setValues       改善率
───────────────────────────────────────────────────
1セット     200-800ms       200-500ms       -
3セット     600-2400ms      200-500ms       75%↓
5セット     1000-4000ms     200-500ms       87%↓
10セット    2000-8000ms     300-800ms       90%↓
```

---

## 🎯 エラー発生条件マトリックス

### 302エラー

| デプロイ設定            | テストデプロイ | 本番デプロイ | URL最新 | 結果 |
|:-----------------------|:--------------|:------------|:-------|:-----|
| `USER_DEPLOYING`       | ✅            | -           | ✅     | 🔴 302エラー |
| `USER_DEPLOYING`       | -             | ✅          | ✅     | ⚠️ 302エラー（可能性） |
| `USER_DEPLOYING`       | -             | ✅          | ❌     | 🔴 302エラー |
| `USER_ACCESSING`       | ✅            | -           | ✅     | ⚠️ URL変更リスク |
| `USER_ACCESSING`       | -             | ✅          | ✅     | ✅ 正常動作 |

### request_timeout エラー

| メッセージ種類        | セット数 | データ行数 | 処理時間 | 結果 |
|:---------------------|:--------|:----------|:--------|:-----|
| 通常トレーニング     | 1-3     | 任意      | 2-5秒   | ✅ 成功 |
| 通常トレーニング     | 4-7     | 任意      | 3-8秒   | ⚠️ 境界 |
| 通常トレーニング     | 8-10+   | 任意      | 4-14秒  | 🔴 タイムアウト |
| JSON書き出し         | -       | 100       | 4-8秒   | ⚠️ 境界 |
| JSON書き出し         | -       | 500       | 6-11秒  | 🔴 タイムアウト |
| JSON書き出し         | -       | 1000+     | 8-15秒  | 🔴🔴 確実にタイムアウト |

---

## 🔧 対策効果の試算

### 最適化1: appendRow → setValues

```
【Before】
10セット × 200-800ms = 2000-8000ms

【After】
1回のsetValues = 300-800ms

【効果】
1700-7200ms 短縮 (約85%削減)
```

### 最適化2: ユーザー認証キャッシュ

```
【Before】
毎回スプレッドシート読み込み = 500-1500ms

【After】
2回目以降はキャッシュ使用 = 10-50ms

【効果】
490-1450ms 短縮 (約97%削減、2回目以降)
```

### 最適化3: JSON書き出し非同期化

```
【Before】
doPost内で同期実行 = 5000-14000ms → タイムアウト

【After】
受付のみ doPost = 100-500ms
実際の処理は別トリガー = 無制限

【効果】
タイムアウトリスク完全回避
```

### 総合効果（通常メッセージ、10セット）

```
【Before】
┌────────────────────────────────────┐
│ ユーザー認証:    500-1500ms       │
│ メッセージ処理:  50-100ms         │
│ appendRow×10:    2000-8000ms  ⚠️  │
│ LINE返信:        500-2000ms       │
├────────────────────────────────────┤
│ 合計:           3050-11600ms      │
│ → 11.6秒でタイムアウトリスク      │
└────────────────────────────────────┘

【After】
┌────────────────────────────────────┐
│ ユーザー認証:    10-50ms    (cache)│
│ メッセージ処理:  50-100ms         │
│ setValues×1:     300-800ms    ✅  │
│ LINE返信:        500-2000ms       │
├────────────────────────────────────┤
│ 合計:           860-2950ms        │
│ → 約3秒、安全圏               ✅  │
└────────────────────────────────────┘

【改善率】
処理時間: 71-75%削減
タイムアウトリスク: ほぼゼロ
```

---

**図解作成日**: 2025年11月15日
